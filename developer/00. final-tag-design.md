# Memos 树形标签系统设计

## API 设计

### 标签操作
- **不提供**: CreateTag API - 标签跟随内容自动创建
- **提供**: 标签查询（只读）、删除（从内容移除）、元数据管理、重命名

### 重命名逻辑
- 本质：找到所有使用旧标签的内容，替换为新标签
- 支持路径移动：`#work/project1` → `#personal/project1`
- 子标签自动跟随：重命名 `#work` 时，`#work/project1` → `#business/project1`
- 原子操作：整个过程在一个事务中完成

### 删除策略
- **从内容移除**：从所有 memo 内容中移除该标签（默认）
- **删除相关 memo**：删除包含该标签的所有 memo
- **智能清理**：删除 `#work/project1/backend` 时，检查并清理无引用的父级路径

### 搜索行为
- 搜索 `#work` → 找到所有 work 相关内容（包括 work/project1/backend）
- 统计逻辑：`#work` 使用次数 = 直接使用次数 + 所有子标签使用次数

## Server 实现

### 标签生命周期
- 标签完全由 memo 内容驱动，写 `#work/project1/backend` 自动创建标签结构
- 生命周期与内容使用同步，无需手动管理
- 标签不被任何 memo 使用时自动删除

### 引用计数机制
- memo 添加标签时，ref_count +1
- memo 删除标签时，ref_count -1
- ref_count = 0 的标签自动删除
- memo 内容更新和标签计数更新在同一事务中

### 层级搜索实现
- 前缀匹配策略：搜索 `#work` → 查找 `full_path LIKE '/work%'`
- 避免复杂的树遍历算法
- 支持高效的数据库索引

### 路径规范
- 大小写敏感：`#Work` 和 `#work` 是不同标签
- 不支持空白字符：空格、制表符、换行符等
- 支持中文路径：`#工作/项目1/后端`
- 分隔符：统一使用 `/`
- 深度限制：最多 5 层

## 数据库设计

### 核心表结构
```
tag_node:
- name: 标签显示名称
- full_path: 完整路径
- path_segments: 路径分段数组
- ref_count: 引用计数
- creator_id: 用户隔离
```

### 设计选择
- **路径存储 vs parent_id**：选择路径存储
- 原因：前缀匹配查询比递归 JOIN 快数倍，API 友好，索引效率高
- 权衡：存储冗余换取查询性能

### 索引策略
- 路径前缀索引：支持层级查询
- 引用计数索引：快速找到无用标签
- 用户隔离索引：多租户性能

### 性能边界
- 单用户标签总数：< 10,000 个
- 路径深度：≤ 5 层
- 标签名称长度：≤ 50 字符
- 路径总长度：≤ 200 字符

### 并发控制
- 数据库锁保证同一标签并发修改一致性
- 引用计数更新采用原子操作
- 大批量操作分批处理