⏺ Tag、Memo、Workspace 关系梳理

  根据 proto 设计分析，以下是三者的关系和互动：

  1. 核心数据结构关系

  TagNode 结构

  message TagNode {
    string name = 1;  // 标签的显示名称
  }

  Memo ↔ Tag 关系

  // 在 MemoPayload 中
  message MemoPayload {
    repeated TagNode tags = 3;  // Memo 包含多个 TagNode
  }

  // 在 API 层面的 Memo 中
  message Memo {
    repeated memos.store.TagNode tags = 10;  // 从内容中提取的标签
   (OUTPUT_ONLY)
  }

  Workspace ↔ Tag 关系

  // 在 WorkspaceMemoRelatedSetting 中
  message WorkspaceMemoRelatedSetting {
    repeated TagNode nsfw_tags = 10;  // 标记 NSFW 内容的标签列表
  }

  2. 层级关系图

  Workspace (工作空间)
  ├── WorkspaceSettings
  │   ├── GeneralSetting (主题、注册设置等)
  │   ├── StorageSetting (存储配置)
  │   └── MemoRelatedSetting
  │       ├── 内容长度限制
  │       ├── 可见性策略
  │       ├── 反应表情列表
  │       └── nsfw_tags: []TagNode  ← 工作空间级别的标签策略
  │
  └── Users
      └── Memos (备忘录)
          ├── 基本信息 (name, creator, timestamps)
          ├── 内容和可见性
          ├── MemoPayload
          │   └── tags: []TagNode  ← 备忘录级别的标签
          ├── Attachments (附件)
          ├── Relations (关联)
          └── Comments (评论)

  3. 数据流和互动模式

  3.1 标签的生命周期

  1. 创建: 通过 Memo 内容自动提取或手动添加到 MemoPayload.tags
  2. 存储: 作为 TagNode 对象存储在 MemoPayload 中
  3. 查询: 通过过滤器 tag in ["tagname"] 查找相关 Memo
  4. 统计: 在用户统计中计算标签使用频率 (tagCount[tag.Name]++)
  5. 管理: 通过 RenameMemoTag 和 DeleteMemoTag API 进行批量操作

  3.2 工作空间对标签的控制

  message MemoRelatedSetting {
    bool enable_blur_nsfw_content = 9;     // 启用 NSFW 内容模糊
    repeated TagNode nsfw_tags = 10;       // 定义哪些标签标记为
  NSFW
  }

  - 内容过滤: 工作空间可以定义特定标签为 NSFW，影响内容显示
  - 策略控制: 工作空间设置影响所有用户的标签行为

  3.3 用户视角的标签互动

  // 用户统计中的标签计数
  tagCount := make(map[string]int32)
  for _, memo := range memos {
      for _, tag := range memo.Payload.Tags {
          tagCount[tag.Name]++  // 按标签名称统计
      }
  }

  4. API 交互模式

  4.1 标签相关的 API

  // 重命名标签 (可跨 Memo 操作)
  rpc RenameMemoTag(RenameMemoTagRequest) returns (Empty)

  // 删除标签 (可跨 Memo 操作)
  rpc DeleteMemoTag(DeleteMemoTagRequest) returns (Empty)

  4.2 过滤和查询

  - 按标签过滤: Filters: ["tag in [\"tagname\"]"]
  - 标签统计: 在 GetUserStats 中统计用户的标签使用情况
  - 跨 Memo 操作: parent=memos/- 可以对所有 Memo 执行标签操作

  5. 关键设计特点

  5.1 标签的范围

  - Memo 级别: 每个 Memo 有自己的标签列表
  - Workspace 级别: 定义全局标签策略（如 NSFW 标签）
  - 用户级别: 统计用户的标签使用情况

  5.2 标签的数据流

  用户创建/编辑 Memo
         ↓
  提取/添加 TagNode 到 MemoPayload.tags
         ↓
  存储到数据库 (需要迁移: string[] → TagNode[])
         ↓
  API 返回时填充 Memo.tags (OUTPUT_ONLY)
         ↓
  前端显示和交互
         ↓
  工作空间策略应用 (NSFW 模糊等)

  5.3 向后兼容性

  - 保留 RenameMemoTag 和 DeleteMemoTag 的字符串接口
  - 过滤器语法仍使用字符串格式 "tag in [\"name\"]"
  - 逐步从 []string 迁移到 []TagNode

  6. 待迁移的数据库结构

  -- 当前: JSON 数组的字符串
  {"tags": ["tag1", "tag2"]}

  -- 目标: TagNode 对象数组
  {"tags": [{"name": "tag1"}, {"name": "tag2"}]}

  这个设计提供了灵活的标签系统，支持 Memo 级别的标签管理和
  Workspace 级别的策略控制，同时保持了良好的扩展性。
