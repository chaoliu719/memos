# Memos æ ‡ç­¾ API é‡æ„è®¾è®¡

## ğŸ¯ è®¾è®¡åŸåˆ™

1. **Tag æ˜¯è¿è¡Œæ—¶çš„é‡**ï¼šä» memo å†…å®¹è§£æå‡ºçš„ç»“æ„åŒ–å…ƒæ•°æ®ï¼Œå­˜å‚¨åœ¨ payload ä¸­ç”¨äºæŸ¥è¯¢ä¼˜åŒ–
2. **Tag æ ‘åŒ…å« memo å…³ç³»**ï¼šæ¯ä¸ª TagNode åŒ…å«ä½¿ç”¨å®ƒçš„æ‰€æœ‰ memo_idsï¼Œè€Œéç®€å•çš„å¼•ç”¨è®¡æ•°
3. **ç”Ÿå‘½å‘¨æœŸç”±å†…å®¹é©±åŠ¨**ï¼šæ ‡ç­¾å®Œå…¨ç”± memo å†…å®¹å†³å®šï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
4. **æ”¯æŒå±‚çº§æŸ¥è¯¢**ï¼šå‰ç¼€åŒ¹é…å®ç°é«˜æ•ˆçš„æ ‘å½¢æŸ¥è¯¢

## ğŸš¨ ç ´åæ€§ä¿®æ”¹æ¦‚è§ˆ

### 1. è°ƒæ•´ç°æœ‰ Memo çº§åˆ« Tag æ“ä½œ

åŸºäº**å•ä¸€èŒè´£åŸåˆ™**çš„æœ€å°ä¿®æ”¹ï¼š

- ğŸ”§ **ä¿®æ”¹**: `RenameMemoTag` API - **ç§»é™¤å…¨å±€é‡å‘½ååŠŸèƒ½**ï¼Œåªä¿ç•™å•ä¸ª memo æ“ä½œ
  - âŒ ä¸å†æ”¯æŒ `parent = "memos/-"` çš„å…¨å±€é‡å‘½å
  - ğŸ”„ **æ›¿ä»£æ–¹æ¡ˆ**: ä½¿ç”¨ `TagService.RenameTag` è¿›è¡Œå…¨å±€æ ‡ç­¾é‡å‘½å
  - âœ… ä¿ç•™ `parent = "memos/{memo_id}"` çš„å•ä¸ª memo é‡å‘½å
- ğŸ”§ **ä¿®æ”¹**: `DeleteMemoTag` API - **ç§»é™¤å…¨å±€åˆ é™¤åŠŸèƒ½**ï¼Œåªä¿ç•™å•ä¸ª memo æ“ä½œ
  - âŒ ä¸å†æ”¯æŒ `parent = "memos/-"` çš„å…¨å±€åˆ é™¤
  - ğŸ”„ **æ›¿ä»£æ–¹æ¡ˆ**: ä½¿ç”¨ `TagService.DeleteTag` åˆ é™¤å…¨å±€æ ‡ç­¾ï¼Œæˆ–ä½¿ç”¨ `MemoService.BatchDeleteMemosByTag` æ‰¹é‡åˆ é™¤åŒ…å«ç‰¹å®šæ ‡ç­¾çš„ memos
  - âœ… ä¿ç•™ `parent = "memos/{memo_id}"` çš„å•ä¸ª memo æ ‡ç­¾åˆ é™¤
- âœ… **æ–°å¢**: ä¸“é—¨çš„ `TagService` å¤„ç†å…¨å±€æ ‡ç­¾æ“ä½œ

### 2. æ•°æ®æ¨¡å‹å¢å¼º
- âœ… **æ‰©å±•**: `TagNode` ç»“æ„ï¼Œæ”¯æŒå±‚çº§è·¯å¾„å’Œ memo å…³è”
- âœ… **æ–°å¢**: ç‹¬ç«‹çš„ `TagService`ï¼Œä¸“é—¨å¤„ç†æ ‡ç­¾ç›¸å…³æ“ä½œ
- âœ… **æ–°å¢**: æ‰¹é‡åˆ é™¤å«ç‰¹å®šæ ‡ç­¾çš„ memos åŠŸèƒ½

## ğŸ“Š æ–°çš„æ•°æ®ç»“æ„

### TagNode å¢å¼º (`/proto/store/tag.proto`)

```protobuf
message TagNode {
  // The full hierarchical path (e.g., "/work/project1/backend")
  // åœ¨æ ‘å½¢æ ‡ç­¾ç³»ç»Ÿä¸­ï¼Œname å­—æ®µè‡ªç„¶æ¼”å˜ä¸ºå®Œæ•´è·¯å¾„ï¼Œä½œä¸ºæ ‡ç­¾çš„å”¯ä¸€æ ‡è¯†ç¬¦
  string name = 1;

  // ğŸš¨ NEW: Path segments for efficient querying (e.g., ["work", "project1", "backend"])
  repeated string path_segments = 2;

  // ğŸš¨ NEW: All memo IDs that use this tag
  repeated string memo_ids = 3;

  // ğŸš¨ NEW: Creator for user isolation
  int32 creator_id = 4;
}
```

### å…³é”®è®¾è®¡å†³ç­–

#### ä¸ºä»€ä¹ˆä¿ç•™ `name` å­—æ®µä½œä¸ºå®Œæ•´è·¯å¾„ï¼Ÿ

1. **è¯­ä¹‰ä¸€è‡´**ï¼š`name` å­—æ®µä¸€ç›´æ˜¯æ ‡ç­¾çš„æ ‡è¯†ç¬¦ï¼Œåœ¨æ ‘å½¢ç³»ç»Ÿä¸­è‡ªç„¶æ¼”å˜ä¸ºå®Œæ•´è·¯å¾„
2. **æœ€å°å˜æ›´**ï¼šä¸éœ€è¦é‡å‘½åç°æœ‰å­—æ®µï¼Œå‡å°‘ç ´åæ€§ä¿®æ”¹
3. **å‘åå…¼å®¹**ï¼šç°æœ‰ä»£ç å¯ä»¥ç»§ç»­ä½¿ç”¨ `name` å­—æ®µ
4. **è®¡ç®—æ˜¾ç¤ºåç§°**ï¼šå¶å­èŠ‚ç‚¹åç§°å¯ä»¥ä» `path_segments` çš„æœ€åä¸€ä¸ªå…ƒç´ è·å¾—

#### å¦‚ä½•è·å–æ ‡ç­¾çš„æ˜¾ç¤ºåç§°ï¼Ÿ

```go
// ä» TagNode è®¡ç®—æ˜¾ç¤ºåç§°
func (t *TagNode) GetDisplayName() string {
    if len(t.PathSegments) == 0 {
        return t.Name // fallback to full path
    }
    return t.PathSegments[len(t.PathSegments)-1] // å–æœ€åä¸€æ®µ
}

// ç¤ºä¾‹ï¼š
// name: "/work/project1/backend"
// path_segments: ["work", "project1", "backend"]
// display_name: "backend"
```

#### ä¸ºä»€ä¹ˆé€‰æ‹© memo_ids è€Œé ref_countï¼Ÿ

1. **æ›´ä¸°å¯Œçš„ä¿¡æ¯**ï¼šç›´æ¥çŸ¥é“å“ªäº› memo ä½¿ç”¨äº†è¯¥æ ‡ç­¾
2. **æ”¯æŒå¤æ‚æ“ä½œ**ï¼šæ‰¹é‡åˆ é™¤ã€æ ‡ç­¾é‡å‘½åç­‰æ“ä½œå¯ä»¥ç›´æ¥è·å–å½±å“çš„ memo åˆ—è¡¨
3. **ä¾¿äºè°ƒè¯•**ï¼šå¯ä»¥ç›´æ¥æŸ¥çœ‹æ ‡ç­¾å’Œå†…å®¹çš„å…³è”å…³ç³»
4. **ç»Ÿè®¡çµæ´»æ€§**ï¼š
   - `direct_memo_count = len(memo_ids)` - ç›´æ¥ä½¿ç”¨è¯¥æ ‡ç­¾çš„æ•°é‡
   - `total_memo_count` - åŒ…æ‹¬å­æ ‡ç­¾çš„æ€»æ•°é‡

### å­˜å‚¨æ–¹æ¡ˆè®¾è®¡

**TagNode ç»§ç»­å­˜å‚¨åœ¨ memo payload ä¸­**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

#### âœ… ç»§ç»­ä½¿ç”¨ JSON å­˜å‚¨çš„ä¼˜åŠ¿

1. **æ¶æ„ä¸€è‡´æ€§**ï¼š
   - Memos åœ¨ v0.22 æ˜ç¡®é€‰æ‹©äº† payload è®¾è®¡æ¨¡å¼
   - æ ‡ç­¾æ˜¯ä»å†…å®¹è§£æå‡ºçš„**å…ƒæ•°æ®**ï¼Œä¸æ˜¯ç‹¬ç«‹ä¸šåŠ¡å®ä½“
   - ä¸ç°æœ‰ `property`ã€`location` ä¿æŒè®¾è®¡ä¸€è‡´æ€§

2. **ç°æœ‰æŸ¥è¯¢æ€§èƒ½ä¼˜ç§€**ï¼š
   - SQLite: `JSON_EACH()` + `JSON_EXTRACT()` æœ‰ä¸“é—¨ä¼˜åŒ–
   - MySQL: `JSON_SEARCH()` æ¯”å¤šè¡¨ JOIN æ›´é«˜æ•ˆ
   - PostgreSQL: `jsonb` æ”¯æŒ GIN ç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½å¼ºåŠ²

3. **äº‹åŠ¡ä¸€è‡´æ€§å¤©ç„¶ä¿è¯**ï¼š
   - memo å†…å®¹å’Œæ ‡ç­¾åœ¨åŒä¸€è¡Œï¼ŒåŸå­æ›´æ–°
   - é¿å…åˆ†å¸ƒå¼äº‹åŠ¡å¤æ‚æ€§
   - æ ‡ç­¾ç”Ÿå‘½å‘¨æœŸä¸ memo è‡ªåŠ¨åŒæ­¥

4. **å¼€å‘ç®€å•æ€§**ï¼š
   - æ— éœ€ç»´æŠ¤å¤æ‚çš„ memo-tag å…³è”è¡¨
   - æ–°å¢å­—æ®µæ— éœ€ ALTER TABLE
   - å‡å°‘æ•°æ®ä¸ä¸€è‡´é£é™©

#### TagNode ä½¿ç”¨åœºæ™¯åˆ†å±‚

**Memo Payload å­˜å‚¨**ï¼ˆç²¾ç®€ç‰ˆï¼‰
```json
// memo.payload ä¸­å­˜å‚¨ç»“æ„åŒ–æ ‡ç­¾ä¿¡æ¯
{
  "payload": {
    "tags": [
      {
        "name": "/work/project1/backend",
        "path_segments": ["work", "project1", "backend"]
        // memo_ids å’Œ creator_id ä¸åœ¨è¿™é‡Œå­˜å‚¨ï¼Œé¿å…æ•°æ®å†—ä½™
      }
    ]
  }
}
```

**TagService API è¿”å›**ï¼ˆå®Œæ•´ç‰ˆï¼‰
```protobuf
// TagService è¿”å›å®Œæ•´çš„ TagNodeï¼ŒåŒ…å«èšåˆä¿¡æ¯
message TagNode {
  string name = 1;                    // å®Œæ•´è·¯å¾„
  repeated string path_segments = 2;  // è·¯å¾„åˆ†æ®µ
  repeated string memo_ids = 3;       // è¿è¡Œæ—¶èšåˆçš„ memo åˆ—è¡¨
  int32 creator_id = 4;               // ä»æŸ¥è¯¢ä¸Šä¸‹æ–‡æ¨å¯¼
}
```
#### TagService èšåˆé€»è¾‘

TagService é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°æ ‡ç­¾çš„è¿è¡Œæ—¶èšåˆï¼š

1. **æŸ¥è¯¢ç”¨æˆ· memos**ï¼šè·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰ memos åŠå…¶ payload
2. **æå–æ ‡ç­¾ä¿¡æ¯**ï¼šä»æ¯ä¸ª memo çš„ payload.tags ä¸­æå– TagNode
3. **èšåˆç»Ÿè®¡**ï¼šæŒ‰ `name` åˆ†ç»„ï¼Œæ”¶é›†ä½¿ç”¨è¯¥æ ‡ç­¾çš„æ‰€æœ‰ memo_ids
4. **è®¡ç®—å±‚çº§å…³ç³»**ï¼šåŸºäº `path_segments` æ„å»ºçˆ¶å­å…³ç³»å’Œç»Ÿè®¡ä¿¡æ¯
5. **è¿”å›å®Œæ•´ TagNode**ï¼šåŒ…å« `memo_ids`ã€`creator_id` ç­‰èšåˆä¿¡æ¯

#### æ•°æ®åº“æ¶æ„ä¿æŒä¸å˜

```sql
-- memo è¡¨ç»“æ„ä¿æŒç°æœ‰è®¾è®¡
CREATE TABLE memo (
  ...
  payload TEXT NOT NULL DEFAULT '{}'  -- ç»§ç»­ä½¿ç”¨ JSON å­˜å‚¨
);
```

#### æŸ¥è¯¢å…¼å®¹æ€§

ç°æœ‰çš„æ ‡ç­¾è¿‡æ»¤è¯­æ³•å®Œå…¨å…¼å®¹ï¼š
- `tag in ["work"]` â†’ åŒ¹é… `name` å­—æ®µåŒ…å« "work" çš„æ ‡ç­¾
- æ”¯æŒå±‚çº§æŸ¥è¯¢ï¼š`tag in ["/work"]` â†’ åŒ¹é…æ‰€æœ‰ `/work/*` è·¯å¾„
- ç»§ç»­ä½¿ç”¨ç°æœ‰çš„ JSON æŸ¥è¯¢ä¼˜åŒ–

## ğŸ—ï¸ API é‡æ„è®¾è®¡åŸåˆ™

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

#### 1. å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibility Principleï¼‰

æˆ‘ä»¬å°†æ ‡ç­¾ç›¸å…³æ“ä½œæŒ‰ç…§èŒè´£èŒƒå›´è¿›è¡Œäº†å½»åº•åˆ†ç¦»ï¼š

- **`MemoService.RenameMemoTag`** - è´Ÿè´£å¤„ç†**å•ä¸ªå¤‡å¿˜å½•**çš„æ ‡ç­¾é‡å‘½åï¼ˆç§»é™¤å…¨å±€åŠŸèƒ½ï¼‰
- **`TagService.RenameTag`** - è´Ÿè´£å¤„ç†**å…¨å±€æ ‡ç­¾**çš„é‡å‘½åæ“ä½œ
- **`MemoService.BatchDeleteMemosByTag`** - ä¸“é—¨è´Ÿè´£æ‰¹é‡åˆ é™¤å«ç‰¹å®šæ ‡ç­¾çš„å¤‡å¿˜å½•
- **`TagService.DeleteTag`** - ä¸“é—¨è´Ÿè´£ä»ç³»ç»Ÿä¸­åˆ é™¤æ ‡ç­¾æœ¬èº«

#### 2. è¯­ä¹‰æ¸…æ™°åŸåˆ™ï¼ˆSemantic Clarityï¼‰

- **`RenameMemoTag`** ä¿æŒåŸæœ‰ API è®¾è®¡ï¼Œä»…ç§»é™¤å…¨å±€æ“ä½œæ”¯æŒï¼ˆ`parent = "memos/-"`ï¼‰
- **é¿å…æ¨¡ç³Šæ“ä½œ**ï¼šç§»é™¤äº† `DeleteMemoTag`ï¼Œå› ä¸ºå®ƒçš„è¯­ä¹‰ä¸å¤Ÿæ˜ç¡®ï¼ˆåˆ é™¤æ ‡ç­¾è¿˜æ˜¯åˆ é™¤å¤‡å¿˜å½•ï¼Ÿï¼‰
- **æ˜ç¡®æ“ä½œèŒƒå›´**ï¼šé€šè¿‡å‘½åæ¸…æ™°è¡¨è¾¾æ“ä½œçš„å½±å“èŒƒå›´ï¼ˆå•ä¸ª vs å…¨å±€ï¼Œæ ‡ç­¾ vs å¤‡å¿˜å½•ï¼‰

#### 3. é¿å…æ­§ä¹‰å’Œå±é™©æ“ä½œ

- **åˆ†ç¦»å¤åˆæ“ä½œ**ï¼šä¸åœ¨å•ä¸ª API ä¸­æ‰§è¡Œè¯­ä¹‰ä¸æ˜ç¡®æˆ–å…·æœ‰æ½œåœ¨å±é™©çš„å¤åˆæ“ä½œ
- **æ˜ç¡®æ‰¹é‡æ“ä½œ**ï¼š`BatchDeleteMemosByTag` æ˜ç¡®è¡¨è¾¾è¿™æ˜¯æ‰¹é‡åˆ é™¤å¤‡å¿˜å½•ï¼Œè€Œéæ ‡ç­¾
- **æä¾›å®‰å…¨æœºåˆ¶**ï¼šæ”¯æŒ `dry_run` å‚æ•°é¢„è§ˆæ“ä½œç»“æœ

### å¼€å‘è€…ä½¿ç”¨æŒ‡å—

åŸºäºè¿™äº›è®¾è®¡åŸåˆ™ï¼Œå¼€å‘è€…ä¼šæ¸…æ¥šåœ°çŸ¥é“ï¼š

| éœ€æ±‚ | åº”è¯¥è°ƒç”¨çš„ API | èŒè´£èŒƒå›´ |
|------|---------------|---------|
| é‡å‘½åæŸä¸ªå¤‡å¿˜å½•çš„æ ‡ç­¾ | `MemoService.RenameMemoTag` | å•ä¸ªå¤‡å¿˜å½• |
| åœ¨æ•´ä¸ªç³»ç»Ÿä¸­é‡å‘½åæ ‡ç­¾ | `TagService.RenameTag` | å…¨å±€æ ‡ç­¾ç³»ç»Ÿ |
| æ‰¹é‡åˆ é™¤å¸¦æœ‰æŸä¸ªæ ‡ç­¾çš„å¤‡å¿˜å½• | `MemoService.BatchDeleteMemosByTag` | æ‰¹é‡å¤‡å¿˜å½•æ“ä½œ |
| ä»ç³»ç»Ÿä¸­åˆ é™¤æ ‡ç­¾ | `TagService.DeleteTag` | å…¨å±€æ ‡ç­¾ç®¡ç† |

è¿™ç§è®¾è®¡æå¤§æé«˜äº† API çš„**å¯ç»´æŠ¤æ€§**ã€**å¯é¢„æµ‹æ€§**å’Œ**å®‰å…¨æ€§**ã€‚

### æœ€å°ä¿®æ”¹åŸåˆ™

è¿™æ¬¡é‡æ„éµå¾ª**æœ€å°ä¿®æ”¹åŸåˆ™**ï¼Œæœ€å¤§ç¨‹åº¦ä¿ç•™åŸæœ‰è®¾è®¡ï¼š

1. **ä¿æŒç°æœ‰ API ç»“æ„**ï¼š`RenameMemoTag` å’Œ `DeleteMemoTag` çš„ç­¾åå’Œè¡Œä¸ºä¿æŒä¸å˜
2. **åªç§»é™¤å…¨å±€åŠŸèƒ½**ï¼šä¸å†æ”¯æŒ `parent = "memos/-"` çš„å…¨å±€æ“ä½œ
3. **æœåŠ¡ç«¯å®ç°è°ƒæ•´**ï¼šåªéœ€è¦åœ¨ç°æœ‰ä»£ç ä¸­æ·»åŠ å‚æ•°éªŒè¯ï¼Œæ‹’ç» `"memos/-"` è¯·æ±‚
4. **å‘åå…¼å®¹**ï¼šç°æœ‰å®¢æˆ·ç«¯å¯¹å•ä¸ª memo çš„è°ƒç”¨å®Œå…¨ä¸å—å½±å“

## ğŸ”§ æ–°çš„ API è®¾è®¡

### TagService (`/proto/api/v1/tag_service.proto`)

```protobuf
service TagService {
  // List all tags with optional filtering
  rpc ListTags(ListTagsRequest) returns (ListTagsResponse) {
    option (google.api.http) = {
      get: "/api/v1/tags"
    };
  }

  // Get specific tag details
  rpc GetTag(GetTagRequest) returns (GetTagResponse) {
    option (google.api.http) = {
      get: "/api/v1/tags/{tag_path=**}"  // ** for path parameters with '/'
    };
    option (google.api.method_signature) = "tag_path";
  }

  // Rename tag globally (supports path moving)
  rpc RenameTag(RenameTagRequest) returns (RenameTagResponse) {
    option (google.api.http) = {
      patch: "/api/v1/tags/{old_tag_path=**}:rename"
      body: "*"
    };
    option (google.api.method_signature) = "old_tag_path,new_tag_path";
  }

  // Delete tag from all content (without deleting memos)
  rpc DeleteTag(DeleteTagRequest) returns (DeleteTagResponse) {
    option (google.api.http) = {
      delete: "/api/v1/tags/{tag_path=**}"
    };
    option (google.api.method_signature) = "tag_path";
  }
}
```

### MemoService è°ƒæ•´

```protobuf
service MemoService {
  // ... ç°æœ‰çš„ API ...

  // ğŸ”§ MODIFIED: ä¿æŒç°æœ‰ APIï¼Œä»…ç§»é™¤å…¨å±€æ“ä½œæ”¯æŒ
  rpc RenameMemoTag(RenameMemoTagRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      patch: "/api/v1/{parent=memos/*}/tags:rename"
      body: "*"
    };
    option (google.api.method_signature) = "parent,old_tag,new_tag";
  }

  // ğŸ”§ MODIFIED: ä¿æŒç°æœ‰ APIï¼Œä»…ç§»é™¤å…¨å±€æ“ä½œæ”¯æŒ
  rpc DeleteMemoTag(DeleteMemoTagRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/{parent=memos/*}/tags/{tag}"};
    option (google.api.method_signature) = "parent,tag";
  }

  // ğŸš¨ NEW: Batch delete memos by tag (using query parameters)
  rpc BatchDeleteMemosByTag(BatchDeleteMemosByTagRequest) returns (BatchDeleteMemosByTagResponse) {
    option (google.api.http) = {
      delete: "/api/v1/memos"  // æŸ¥è¯¢å‚æ•°: ?tag_path=...&include_children=...&dry_run=...
    };
    option (google.api.method_signature) = "tag_path";
  }
}
```

## ğŸŒ RESTful HTTP æ˜ å°„

### URL è®¾è®¡åŸåˆ™

1. **è·¯å¾„å‚æ•°å¤„ç†**ï¼šä½¿ç”¨ `{tag_path=**}` æ”¯æŒè·¯å¾„ä¸­çš„ `/` å­—ç¬¦
2. **URL ç¼–ç **ï¼šå®¢æˆ·ç«¯éœ€è¦å¯¹åŒ…å« `/` çš„æ ‡ç­¾è·¯å¾„è¿›è¡Œç¼–ç 
   - ä¾‹ï¼š`/work/project1` â†’ `/api/v1/tags/%2Fwork%2Fproject1`
3. **æŸ¥è¯¢å‚æ•°**ï¼šå¤æ‚å‚æ•°é€šè¿‡æŸ¥è¯¢å‚æ•°ä¼ é€’ï¼Œé¿å… DELETE è¯·æ±‚ä½“å…¼å®¹æ€§é—®é¢˜

### API ç«¯ç‚¹æ˜ å°„

| æ“ä½œ | HTTP æ–¹æ³• | URL | è¯´æ˜ |
|------|-----------|-----|------|
| åˆ—å‡ºæ ‡ç­¾ | GET | `/api/v1/tags?path_prefix=...&include_memo_ids=...` | æ”¯æŒå‰ç¼€è¿‡æ»¤ |
| è·å–æ ‡ç­¾ | GET | `/api/v1/tags/{encoded_tag_path}?include_memo_ids=true` | è·å–å•ä¸ªæ ‡ç­¾è¯¦æƒ… |
| é‡å‘½åæ ‡ç­¾ï¼ˆå…¨å±€ï¼‰ | PATCH | `/api/v1/tags/{encoded_old_path}:rename` | å…¨å±€æ ‡ç­¾é‡å‘½å |
| åˆ é™¤æ ‡ç­¾ï¼ˆå…¨å±€ï¼‰ | DELETE | `/api/v1/tags/{encoded_tag_path}?strategy=...` | ä»ç³»ç»Ÿä¸­åˆ é™¤æ ‡ç­¾ |
| é‡å‘½åå¤‡å¿˜å½•æ ‡ç­¾ | PATCH | `/api/v1/memos/{memo_id}/tags:rename` | é‡å‘½åå•ä¸ªå¤‡å¿˜å½•çš„ç‰¹å®šæ ‡ç­¾ |
| åˆ é™¤å¤‡å¿˜å½•æ ‡ç­¾ | DELETE | `/api/v1/memos/{memo_id}/tags/{tag_name}` | åˆ é™¤å•ä¸ªå¤‡å¿˜å½•çš„ç‰¹å®šæ ‡ç­¾ |
| æ‰¹é‡åˆ é™¤å¤‡å¿˜å½• | DELETE | `/api/v1/memos?tag_path=...&include_children=...&dry_run=...` | åˆ é™¤åŒ…å«æ ‡ç­¾çš„å¤‡å¿˜å½• |

## ğŸ“‹ è¯·æ±‚/å“åº”æ¶ˆæ¯

### æ ¸å¿ƒè¯·æ±‚æ¶ˆæ¯

```protobuf
message ListTagsRequest {
  // Query parameter: ?path_prefix=/work
  string path_prefix = 1;

  // Query parameter: ?include_memo_ids=true
  // Server default: false if not specified
  bool include_memo_ids = 2;

  // Query parameter: ?include_hierarchy=true
  // Server default: true if not specified
  bool include_hierarchy = 3;
}

message GetTagRequest {
  // Path parameter: /api/v1/tags/{tag_path}
  // URL encoded if contains '/' (e.g., %2Fwork%2Fproject1)
  string tag_path = 1 [(google.api.field_behavior) = REQUIRED];

  // Query parameter: ?include_memo_ids=true
  // Server default: true if not specified
  bool include_memo_ids = 2;
}

message RenameTagRequest {
  // Path parameter: /api/v1/tags/{old_tag_path}:rename
  string old_tag_path = 1 [(google.api.field_behavior) = REQUIRED];

  // Request body field
  string new_tag_path = 2 [(google.api.field_behavior) = REQUIRED];

  // Request body field - Server default: true if not specified
  bool move_children = 3;
}

message DeleteTagRequest {
  // Path parameter: /api/v1/tags/{tag_path}
  string tag_path = 1 [(google.api.field_behavior) = REQUIRED];

  enum DeleteStrategy {
    REMOVE_FROM_CONTENT = 0;  // Remove tag from all memo content
    DELETE_RELATED_MEMOS = 1; // Delete memos containing this tag
  }

  // Query parameter: ?strategy=REMOVE_FROM_CONTENT
  // Server default: REMOVE_FROM_CONTENT if not specified
  DeleteStrategy strategy = 2;
}

// ğŸ”§ MODIFIED: ç°æœ‰æ¶ˆæ¯ä¿æŒä¸å˜ï¼Œä»…æ–‡æ¡£æ›´æ–°
message RenameMemoTagRequest {
  // Required. The parent, who owns the tags.
  // Format: memos/{memo_id} (ä¸å†æ”¯æŒ "memos/-")
  string parent = 1 [(google.api.field_behavior) = REQUIRED];

  // Required. The old tag name to rename.
  string old_tag = 2 [(google.api.field_behavior) = REQUIRED];

  // Required. The new tag name.
  string new_tag = 3 [(google.api.field_behavior) = REQUIRED];
}

message DeleteMemoTagRequest {
  // Required. The parent, who owns the tags.
  // Format: memos/{memo_id} (ä¸å†æ”¯æŒ "memos/-")
  string parent = 1 [(google.api.field_behavior) = REQUIRED];

  // Required. The tag name to delete.
  string tag = 2 [(google.api.field_behavior) = REQUIRED];
}

message BatchDeleteMemosByTagRequest {
  // Query parameter: ?tag_path=/work/project1
  string tag_path = 1 [(google.api.field_behavior) = REQUIRED];

  // Query parameter: ?include_children=true
  // Server default: true if not specified
  bool include_children = 2;

  // Query parameter: ?dry_run=true
  // Server default: false if not specified
  bool dry_run = 3;
}
```

### ç»Ÿä¸€çš„å“åº”ç»“æ„

```protobuf
message TagWithMemos {
  memos.store.TagNode tag_node = 1;

  // Direct memo count (excluding child tags)
  int32 direct_memo_count = 2;

  // Total memo count (including child tags)
  int32 total_memo_count = 3;

  // Child tag paths
  repeated string child_paths = 4;

  // Parent tag path
  string parent_path = 5;
}

message ListTagsResponse {
  repeated TagWithMemos tags = 1;
  int32 total_count = 2;
}

message GetTagResponse {
  TagWithMemos tag = 1;
}

message RenameTagResponse {
  // Affected memo IDs
  repeated string affected_memo_ids = 1;

  // Old and new tag paths that were changed
  map<string, string> renamed_paths = 2; // old_path -> new_path
}

message DeleteTagResponse {
  // Memo IDs that had this tag removed
  repeated string affected_memo_ids = 1;

  // Tag paths that were deleted
  repeated string deleted_tag_paths = 2;
}

message BatchDeleteMemosByTagResponse {
  repeated string deleted_memo_ids = 1;
  int32 deleted_count = 2;
  repeated string affected_tag_paths = 3;
}
```

## ğŸ”„ æ•°æ®æµå’Œç”Ÿå‘½å‘¨æœŸ

### Tag ç”Ÿå‘½å‘¨æœŸç®¡ç†

1. **åˆ›å»º**ï¼šmemo å†…å®¹è§£ææ—¶è‡ªåŠ¨åˆ›å»º TagNode å¹¶å¡«å…… memo_ids
2. **æ›´æ–°**ï¼šmemo å†…å®¹å˜æ›´æ—¶ï¼Œæ›´æ–°ç›¸å…³ TagNode çš„ memo_ids
3. **åˆ é™¤**ï¼šmemo_ids ä¸ºç©ºçš„ TagNode è‡ªåŠ¨æ¸…ç†

### å±‚çº§æŸ¥è¯¢é€»è¾‘

```sql
-- æŸ¥æ‰¾æ‰€æœ‰ /work ç›¸å…³çš„æ ‡ç­¾ï¼ˆåŒ…æ‹¬å­æ ‡ç­¾ï¼‰
SELECT * FROM tag_nodes WHERE name LIKE '/work%'

-- æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨ /work æ ‡ç­¾çš„ memosï¼ˆåŒ…æ‹¬å­æ ‡ç­¾çš„ memosï¼‰
SELECT DISTINCT memo_id FROM tag_nodes
WHERE name LIKE '/work%'
AND memo_id IN (SELECT unnest(memo_ids))
```

### é‡å‘½åæ“ä½œæµç¨‹

1. **éªŒè¯**ï¼šæ£€æŸ¥æ–°è·¯å¾„æ˜¯å¦å·²å­˜åœ¨
2. **æ”¶é›†**ï¼šè·å–æ‰€æœ‰éœ€è¦é‡å‘½åçš„æ ‡ç­¾è·¯å¾„ï¼ˆåŒ…æ‹¬å­æ ‡ç­¾ï¼‰
3. **æ›´æ–°**ï¼šåœ¨äº‹åŠ¡ä¸­æ›´æ–°æ‰€æœ‰ç›¸å…³çš„ memo å†…å®¹å’Œ TagNode è®°å½•
4. **è¿”å›**ï¼šè¿”å›æ‰€æœ‰å—å½±å“çš„ memo_ids å’Œè·¯å¾„æ˜ å°„

## âš ï¸ å®æ–½æ³¨æ„äº‹é¡¹

### æœåŠ¡ç«¯é»˜è®¤å€¼å¤„ç†

ç”±äº protobuf ä¸­çš„é»˜è®¤å€¼æ³¨é‡Šåªæ˜¯æ–‡æ¡£ï¼ŒæœåŠ¡ç«¯éœ€è¦æ˜¾å¼å¤„ç†ï¼š

```go
// ä¼ªä»£ç ç¤ºä¾‹
func (s *TagService) ListTags(ctx context.Context, req *ListTagsRequest) (*ListTagsResponse, error) {
    // å¤„ç†é»˜è®¤å€¼
    if !req.HasIncludeHierarchy() {
        req.IncludeHierarchy = true  // æœåŠ¡ç«¯é»˜è®¤å€¼
    }
    // ... ä¸šåŠ¡é€»è¾‘
}
```

### URL ç¼–ç å¤„ç†

å®¢æˆ·ç«¯éœ€è¦æ­£ç¡®å¤„ç†åŒ…å« `/` çš„æ ‡ç­¾è·¯å¾„ï¼š

```javascript
// å‰ç«¯ç¤ºä¾‹
const tagPath = "/work/project1";
const encodedPath = encodeURIComponent(tagPath); // %2Fwork%2Fproject1
const url = `/api/v1/tags/${encodedPath}`;
```

### äº‹åŠ¡ä¸€è‡´æ€§

æ ‡ç­¾æ“ä½œæ¶‰åŠå¤šä¸ªæ•°æ®çš„æ›´æ–°ï¼Œéœ€è¦ç¡®ä¿äº‹åŠ¡ä¸€è‡´æ€§ï¼š

1. **memo å†…å®¹æ›´æ–°**å’Œ**TagNode.memo_ids æ›´æ–°**å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­
2. **é‡å‘½åæ“ä½œ**æ¶‰åŠå¤šä¸ª TagNode å’Œ memo è®°å½•ï¼Œéœ€è¦é€‚å½“çš„é”æœºåˆ¶
3. **æ‰¹é‡åˆ é™¤**æ“ä½œéœ€è¦è€ƒè™‘å¹¶å‘å®‰å…¨
