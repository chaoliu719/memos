# Tag Proto 结构改动计划

## 概述
将系统中所有基于 `string` 的标签改为使用新的 `TagNode` 结构，实现标签的结构化存储。

## 改动项目清单

### 1. Proto 文件修改

#### 1.1 `/proto/api/v1/memo_service.proto`
- **当前状态：** 第209行 `repeated string tags = 10 [(google.api.field_behavior) = OUTPUT_ONLY];`
- **改动计划：** 
  - 添加导入：`import "store/tag.proto";`
  - 修改为：`repeated memos.store.TagNode tags = 10 [(google.api.field_behavior) = OUTPUT_ONLY];`

#### 1.2 `/proto/api/v1/workspace_service.proto`  
- **当前状态：** 第172行 `repeated string nsfw_tags = 10;`
- **改动计划：**
  - 添加导入：`import "store/tag.proto";`
  - 修改为：`repeated memos.store.TagNode nsfw_tags = 10;`

#### 1.3 `/proto/store/memo.proto`
- **当前状态：** 第12行 `repeated string tags = 3;`
- **改动计划：**
  - 添加导入：`import "store/tag.proto";`
  - 修改为：`repeated TagNode tags = 3;`

#### 1.4 `/proto/store/workspace_setting.proto`
- **当前状态：** 第117行 `repeated string nsfw_tags = 10;`
- **改动计划：**
  - 添加导入：`import "store/tag.proto";`
  - 修改为：`repeated TagNode nsfw_tags = 10;`

#### 1.5 `/proto/api/v1/markdown_service.proto` - 类型冲突解决
- **当前状态：** 第286行定义本地 `TagNode`，第158行使用
- **改动计划：**
  - 添加导入：`import "store/tag.proto";`
  - 删除本地 `TagNode` 定义
  - 修改为：`memos.store.TagNode tag_node = 59;`

### 2. 后端 Go 代码修改

#### 2.1 API 服务层
- **`/server/router/api/v1/memo_service.go`**
  - 将 `[]string` 标签字段改为 `[]*storepb.TagNode`
  - 更新标签访问逻辑使用 `tag.Name`
- **`/server/router/api/v1/workspace_service.go`**
  - 更新 NSFW 标签处理逻辑

#### 2.2 存储层
- **`/store/workspace_setting.go`**
  - 更新 NSFW 标签序列化/反序列化
  - 将 `[]string` 改为 `[]*storepb.TagNode`

#### 2.3 过滤器和工具类
- **`/plugin/filter/dialect.go`**
  - 更新标签过滤逻辑处理 `TagNode.Name`
- **`/plugin/filter/common_converter.go`**
  - 更新标签转换逻辑
- **`/plugin/filter/templates.go`**
  - 更新标签模板处理

#### 2.4 测试文件
- **`/store/test/memo_test.go`**
  - 更新测试标签数据为 `TagNode` 结构
- **`/server/router/api/v1/test/user_service_stats_test.go`**
  - 更新标签相关测试
- **`/store/db/sqlite/memo_filter_test.go`** & **`/store/db/mysql/memo_filter_test.go`**
  - 更新标签过滤测试

### 3. 前端 TypeScript 代码修改

#### 3.1 类型定义文件（自动生成）
- **`/web/src/types/proto/api/v1/memo_service.ts`**
  - `tags` 从 `string[]` 改为 `TagNode[]`
- **`/web/src/types/proto/api/v1/workspace_service.ts`**
  - `nsfwTags` 从 `string[]` 改为 `TagNode[]`

#### 3.2 组件文件
- **`/web/src/components/MemoView.tsx`**
  - 标签显示使用 `tag.name`
- **`/web/src/components/MemoDetailSidebar/MemoDetailSidebar.tsx`**
  - 详情侧边栏标签处理
- **`/web/src/components/HomeSidebar/TagsSection.tsx`**
  - 标签分区组件更新
- **`/web/src/components/Settings/MemoRelatedSettings.tsx`**
  - NSFW 标签配置界面更新

### 4. 数据库相关

#### 4.1 数据库迁移
- **状态：** 已完成（版本 0.22）
- **无需修改：** 结构已支持 JSON 存储

#### 4.2 数据转换
- **需要考虑：** 现有字符串数据转换为 `{"name": "tag_value"}` 格式
- **可能需要：** 数据迁移脚本

### 5. 构建和生成

#### 5.1 Proto 代码生成
- **操作：** 完成 proto 修改后运行 `buf generate`

#### 5.2 前端类型生成
- **确保：** TypeScript 类型文件同步更新

### 6. 向后兼容性考虑

#### 6.1 API 兼容性
- **风险：** 破坏性变更，所有标签 API 响应格式改变
- **影响：** 客户端需要同步更新

#### 6.2 数据兼容性
- **策略：** 业务逻辑层提供转换函数
- **确保：** 能处理旧格式 JSON 数据

## 实施顺序

1. **第一阶段：** 修改所有 proto 文件
2. **第二阶段：** 重新生成所有代码
3. **第三阶段：** 修改后端业务逻辑
4. **第四阶段：** 修改前端组件
5. **第五阶段：** 更新测试用例
6. **第六阶段：** 测试验证